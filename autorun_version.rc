<ruby>
# auto run version modules on all services
def autorun_mod(mod, regex_sname)
    run_single("use #{mod}")
    framework.db.hosts.each do |host|
        host.services.each do |serv|
            next if not serv.host
            if(serv.name =~ /#{regex_sname}/) # service name (http, ssh, ssl, ftp, ...)
                print_good("Running against #{host.address}:#{serv.port} ...")
                
                # SSL need to be set?
                if(serv.name =~ /ssl|https/)
                    run_single("set SSL true")
                else
                    # explicit is better than implicit... ;)
                    run_single("set SSL false")
                end
                # set vars
                run_single("set RPORT #{serv.port}")
                run_single("set RHOSTS #{host.address}")
                run_single("set RHOST #{host.address}")

                # let it go...
                run_single("run")
            end
        end
    end
    run_single("back")
end

# generate version modules...
# # pwd
# /pentest/metasploit-framework
# # find . -iname '*_version*' | grep -i auxiliary | cut -f3- -d'/' | cut -f1 -d\. | xargs -i echo 'autorun_mod("{}", "xxx")'
#
autorun_mod("auxiliary/scanner/ssh/ssh_version", "ssh")

</ruby>
